<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë∂£Âë≥ÂçïËØçÂ§ßÂÜíÈô© Fun Word Adventure</title>
    <style>
        :root {
            --primary-color: #FF9F1C;
            --secondary-color: #2EC4B6;
            --accent-color: #E71D36;
            --background-color: #CBF3F0;
            --card-bg: #FFFFFF;
            --text-color: #011627;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--secondary-color);
            width: 100%;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: white;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 2em;
            text-shadow: 2px 2px 0px var(--accent-color);
        }

        .container {
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Menu Styles */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .unit-btn {
            background-color: var(--card-bg);
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            text-align: center;
            color: var(--text-color);
            box-shadow: 0 4px 0 var(--primary-color);
        }

        .unit-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .unit-btn:hover {
            background-color: #FFF3E0;
        }

        /* Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            background-color: var(--card-bg);
            border: 4px solid var(--secondary-color);
        }

        .card-front {
            z-index: 2;
        }

        .card-back {
            transform: rotateY(180deg);
            background-color: #E0F7FA;
            border-color: var(--primary-color);
        }

        .word-text {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .meaning-text {
            font-size: 2em;
            color: var(--text-color);
            text-align: center;
            padding: 0 20px;
        }

        .controls {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: all 0.1s;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-accent { background-color: var(--accent-color); }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* Quiz Styles */
        .quiz-container {
            width: 100%;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .quiz-question {
            font-size: 2.5em;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            padding: 15px;
            font-size: 1.2em;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background-color: #e6e6e6;
            transform: scale(1.02);
        }

        .option-btn.correct {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .option-btn.wrong {
            background-color: #f44336;
            color: white;
            border-color: #d32f2f;
        }

        .score-display {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        /* Views */
        .view { display: none; width: 100%; }
        .view.active { display: flex; flex-direction: column; align-items: center; }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: none;
            border: 2px solid white;
            color: white;
            font-size: 1em;
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pop-anim {
            animation: pop 0.3s ease-in-out;
        }

        /* Shake Animation */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            50% { transform: translateX(10px) rotate(5deg); }
            75% { transform: translateX(-10px) rotate(-5deg); }
            100% { transform: translateX(0); }
        }

        .shake-anim {
            animation: shake 0.5s ease-in-out;
            background-color: #ffcccc !important; /* Reddish tint */
        }

        /* Fireworks Canvas */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .speak-btn {
            background: none;
            border: none;
            font-size: 0.6em; /* Relative to word-text font size */
            cursor: pointer;
            margin-left: 10px;
            vertical-align: middle;
            transition: transform 0.2s;
        }
        .speak-btn:hover {
            transform: scale(1.2);
        }
        .speak-btn:active {
            transform: scale(0.9);
        }

        /* Math Styles */
        .math-table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            width: 100%;
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .math-card {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid var(--secondary-color);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .math-card:hover {
            transform: scale(1.05);
            background-color: #E0F7FA;
        }
        .visual-container {
            width: 100%;
            min-height: 150px;
            background-color: white;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            flex-wrap: wrap;
            gap: 10px;
            border: 3px dashed var(--primary-color);
        }
        .calc-icon {
            font-size: 2.5em;
            transition: all 0.5s ease;
        }
        .calc-icon.faded {
            opacity: 0.2;
            transform: scale(0.5);
            text-decoration: line-through;
            color: #ccc;
        }
        .calc-icon.added {
            animation: pop 0.5s ease-in-out;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: scale(0.7);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 4px solid var(--primary-color);
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            line-height: 0.5;
        }
        .modal-title {
            font-size: 2em;
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<canvas id="fireworks-canvas"></canvas>

<!-- Modal -->
<div id="math-modal" class="modal-overlay" onclick="closeMathModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeMathModal()">√ó</button>
        <div id="modal-title" class="modal-title">3 + 2 = 5</div>
        <div id="modal-visuals" class="visual-container" style="border: none; min-height: 200px;"></div>
        <button class="btn btn-primary" onclick="replayMathModal()">üîÑ ÂÜçÁúã‰∏ÄÊ¨° (Replay)</button>
    </div>
</div>

<header>
    <button id="home-btn" class="back-btn" style="display: none;" onclick="goHome()">üè† È¶ñÈ°µ</button>
    <h1>üåü Ë∂£Âë≥Â≠¶‰π†Â§ßÂÜíÈô© üåü</h1>
</header>

<div class="container">
    <!-- Root Menu View -->
    <div id="root-menu-view" class="view active">
        <h2>ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂÜíÈô©Â≤õÔºÅ</h2>
        <div class="menu-grid" style="grid-template-columns: 1fr;">
            <button class="unit-btn" onclick="showWordMenu()" style="border-color: var(--primary-color);">üìö ÂçïËØçÈóØÂÖ≥ (Word Adventure)</button>
            <button class="unit-btn" onclick="showMathTableMenu()" style="border-color: var(--secondary-color);">üî¢ Âä†ÂáèÊ≥ïË°® (Math Tables)</button>
            <button class="unit-btn" onclick="startMathGame()" style="border-color: var(--accent-color);">üßÆ Âä†ÂáèÊ≥ïÈóØÂÖ≥ (Math Challenge)</button>
            <button class="unit-btn" onclick="startLogicGame()" style="border-color: #9C27B0;">üß© Êï∞Â≠¶ÈÄªËæëÊÄùÁª¥ (Logic Mind)</button>
        </div>
    </div>

    <!-- Word Menu View -->
    <div id="word-menu-view" class="view">
        <h2>ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂçïÂÖÉÂºÄÂßãÂÜíÈô©ÔºÅ</h2>
        <div id="unit-list" class="menu-grid">
            <!-- Units will be generated here -->
        </div>
    </div>
    
    <!-- Math Table Menu View -->
    <div id="math-table-view" class="view">
        <div class="controls" style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="renderMathTable('add')">‚ûï Âä†Ê≥ïË°®</button>
            <button class="btn btn-accent" onclick="renderMathTable('sub')">‚ûñ ÂáèÊ≥ïË°®</button>
        </div>
        <div id="math-table-container" class="math-table-grid">
            <!-- Tables generated here -->
        </div>
    </div>

    <!-- Math Game View -->
    <div id="math-game-view" class="view">
        <div class="score-display">ÂæóÂàÜ: <span id="math-score">0</span></div>
        <div class="quiz-container">
            <div class="quiz-question" id="math-question">3 + 2 = ?</div>
            
            <div class="visual-container" id="math-visuals">
                <!-- Visuals like apples go here -->
            </div>
            
            <div class="options-grid" id="math-options">
                <!-- Options generated here -->
            </div>
        </div>
        <div id="math-feedback" style="margin-top: 20px; font-size: 1.5em; height: 1.5em;"></div>
        <div class="controls" style="display: none;" id="math-next-btn-container">
            <button class="btn btn-secondary" onclick="nextMathQuestion()">‰∏ã‰∏ÄÈ¢ò ‚û°Ô∏è</button>
        </div>
    </div>

    <!-- Logic Game View -->
    <div id="logic-game-view" class="view">
        <div class="score-display">ÂæóÂàÜ: <span id="logic-score">0</span></div>
        <div class="progress-bar"><div id="logic-progress" class="progress-fill"></div></div>
        <div class="quiz-container">
            <div class="quiz-question" id="logic-question" style="font-size: 1.8em;">Question?</div>
            <div class="options-grid" id="logic-options">
                <!-- Options generated here -->
            </div>
        </div>
        <div id="logic-feedback" style="margin-top: 20px; font-size: 1.5em; height: 1.5em;"></div>
        <div class="controls" style="display: none;" id="logic-next-btn-container">
            <button class="btn btn-secondary" onclick="nextLogicQuestion()">‰∏ã‰∏ÄÈ¢ò ‚û°Ô∏è</button>
        </div>
    </div>

    <!-- Mode Selection View (Sub-menu) -->
    <div id="mode-view" class="view">
        <h2 id="selected-unit-title">Unit 1</h2>
        <div class="menu-grid" style="grid-template-columns: 1fr;">
            <button class="unit-btn" onclick="startFlashcards()" style="border-color: var(--secondary-color);">üìñ ÂçïËØçÂç°Áâá (Learn)</button>
            <button class="unit-btn" onclick="startQuiz()" style="border-color: var(--accent-color);">üéÆ ÊåëÊàòÊ∏∏Êàè (Game)</button>
        </div>
    </div>

    <!-- Flashcard View -->
    <div id="flashcard-view" class="view">
        <div class="progress-bar"><div id="fc-progress" class="progress-fill"></div></div>
        <div class="flashcard-container" onclick="flipCard()">
            <div class="flashcard" id="card">
                <div class="card-face card-front">
                    <div class="word-text">
                        <span id="fc-word">Hello</span>
                        <button class="speak-btn" onclick="event.stopPropagation(); speakWord();" title="Âê¨ÂèëÈü≥">üîä</button>
                    </div>
                    <div style="font-size: 1.2em; color: #666;">(ÁÇπÂáªÊü•Áúã‰∏≠Êñá)</div>
                </div>
                <div class="card-face card-back">
                    <div class="meaning-text" id="fc-meaning">‰Ω†Â•Ω</div>
                </div>
            </div>
        </div>
        <div class="controls">
            <button class="btn btn-primary" onclick="prevCard()">‚¨ÖÔ∏è ‰∏ä‰∏Ä‰∏™</button>
            <button class="btn btn-secondary" onclick="nextCard()">‰∏ã‰∏Ä‰∏™ ‚û°Ô∏è</button>
        </div>
    </div>

    <!-- Quiz View -->
    <div id="quiz-view" class="view">
        <div class="score-display">ÂæóÂàÜ: <span id="score">0</span></div>
        <div class="progress-bar"><div id="quiz-progress" class="progress-fill"></div></div>
        <div class="quiz-container">
            <div class="quiz-question" id="quiz-question">Question?</div>
            <div class="options-grid" id="quiz-options">
                <!-- Options generated here -->
            </div>
        </div>
        <div id="quiz-feedback" style="margin-top: 20px; font-size: 1.5em; height: 1.5em;"></div>
        <div class="controls" style="display: none;" id="quiz-next-btn-container">
            <button class="btn btn-secondary" onclick="nextQuestion()">‰∏ã‰∏ÄÈ¢ò ‚û°Ô∏è</button>
        </div>
    </div>
    
    <!-- Result View -->
    <div id="result-view" class="view">
        <h2 style="font-size: 3em;">üéâ ÊåëÊàòÂÆåÊàê! üéâ</h2>
        <div style="font-size: 2em; margin: 20px;">ÊúÄÁªàÂæóÂàÜ: <span id="final-score" style="color: var(--accent-color); font-weight: bold;"></span></div>
        <div id="stars" style="font-size: 3em;">‚≠ê‚≠ê‚≠ê</div>
        <button class="btn btn-primary" onclick="goHome()" style="margin-top: 30px;">ËøîÂõûÈ¶ñÈ°µ</button>
    </div>
</div>

<script>
    // --- Data ---
    const vocabulary = {
        "Unit 1": [
            { word: "hello", meaning: "‰Ω†Â•Ω" },
            { word: "nice", meaning: "‰ª§‰∫∫ÊÑâÂø´ÁöÑ" },
            { word: "to", meaning: "(Áî®‰∫éÂä®ËØç„ÄÅÂêçËØçÁ≠âÂêé)‰ΩøÊÑèÊÄùÂÆåÊï¥" },
            { word: "meet", meaning: "ËÆ§ËØÜÔºåÁªìËØÜ" },
            { word: "you", meaning: "‰Ω†" },
            { word: "hi", meaning: "‰Ω†Â•ΩÔºåÂó®" },
            { word: "let's", meaning: "ËÆ©Êàë‰ª¨......Âêß (let us)" },
            { word: "play", meaning: "Áé©ÔºåÁé©ËÄç" },
            { word: "OK", meaning: "Ë°åÔºåÂèØ‰ª•" },
            { word: "be", meaning: "ÊòØ;Êàê‰∏∫" },
            { word: "friend", meaning: "ÊúãÂèã" },
            { word: "I", meaning: "Êàë" },
            { word: "my", meaning: "ÊàëÁöÑ" },
            { word: "name", meaning: "ÂêçÂ≠ó" }
        ],
        "Unit 2": [
            { word: "one", meaning: "‰∏Ä" },
            { word: "little", meaning: "Â∞èÁöÑ" },
            { word: "two", meaning: "‰∫å" },
            { word: "three", meaning: "‰∏â" },
            { word: "bird", meaning: "È∏ü" },
            { word: "four", meaning: "Âõõ" },
            { word: "five", meaning: "‰∫î" },
            { word: "six", meaning: "ÂÖ≠" },
            { word: "in", meaning: "Âú®......ÂÜÖ;ÊéíÂàóÊàê......ÂΩ¢Áä∂" },
            { word: "a/an", meaning: "‰∏Ä(‰∏™)" },
            { word: "line", meaning: "ÊéíÔºåÂàó,Ë°å" },
            { word: "the", meaning: "(ÁâπÊåá)ËøôÔºåÈÇ£" },
            { word: "sky", meaning: "Â§©Á©∫" },
            { word: "take", meaning: "ÊãçÊëÑ" },
            { word: "photo", meaning: "ÁÖßÁâáÔºåÁõ∏Áâá" },
            { word: "together", meaning: "‰∏ÄËµ∑ÔºåÂÖ±Âêå" }
        ],
        "Unit 3": [
            { word: "red", meaning: "Á∫¢Ëâ≤" },
            { word: "like", meaning: "ÂñúÊ¨¢ÔºåÂñúÁà±" },
            { word: "blue", meaning: "ËìùËâ≤" },
            { word: "yellow", meaning: "ÈªÑËâ≤" },
            { word: "green", meaning: "ÁªøËâ≤" },
            { word: "orange", meaning: "Ê©òÈªÑËâ≤ÔºåÊ©ôËâ≤" },
            { word: "colourful", meaning: "Ëâ≤ÂΩ©‰∏∞ÂØåÁöÑ" },
            { word: "picture", meaning: "Áîª,ÂõæÁîª" },
            { word: "what", meaning: "‰ªÄ‰πà" },
            { word: "colour", meaning: "È¢úËâ≤" },
            { word: "it", meaning: "ÂÆÉÔºåËøôÔºåÈÇ£" },
            { word: "look", meaning: "Áûß" },
            { word: "hooray", meaning: "Â•ΩÂìá(Ë°®Á§∫È´òÂÖ¥)" }
        ],
        "Unit 4": [
            { word: "pencil", meaning: "ÈìÖÁ¨î" },
            { word: "ruler", meaning: "Â∞∫Â≠êÔºåÁõ¥Â∞∫" },
            { word: "all", meaning: "ÂÖ®ÈÉ®ÔºåÊâÄÊúâ" },
            { word: "schoolbag", meaning: "‰π¶ÂåÖ" },
            { word: "eraser", meaning: "Ê©°ÁöÆ" },
            { word: "book", meaning: "‰π¶Ôºå‰π¶Á±ç" },
            { word: "share", meaning: "ÂÖ±‰∫´;ÂÖ±Áî®" },
            { word: "oh", meaning: "ÂïäÔºåÂìéÂëÄ" },
            { word: "pencil case", meaning: "Á¨îË¢ã;ÈìÖÁ¨îÁõí" },
            { word: "and", meaning: "ÂíåÔºå‰∏é" },
            { word: "English", meaning: "Ëã±ËØ≠" },
            { word: "don't", meaning: "‰∏çË¶Å (do not)" },
            { word: "worry", meaning: "ÊãÖÂøÉ;ÂèëÊÑÅ" },
            { word: "here", meaning: "Âú®ËøôÈáå;Áªô‰Ω†" },
            { word: "thank", meaning: "ÊÑüË∞¢" }
        ],
        "Unit 5": [
            { word: "good morning", meaning: "Êó©‰∏äÂ•Ω" },
            { word: "teacher", meaning: "ÊïôÂ∏àÔºåËÄÅÂ∏à" },
            { word: "this", meaning: "ËøôÔºåËøô‰∏™" },
            { word: "our", meaning: "Êàë‰ª¨ÁöÑ" },
            { word: "classroom", meaning: "ÊïôÂÆ§" },
            { word: "blackboard", meaning: "ÈªëÊùø" },
            { word: "desk", meaning: "‰π¶Ê°å" },
            { word: "chair", meaning: "Ê§ÖÂ≠ê" },
            { word: "clean", meaning: "ÂºÑÂπ≤ÂáÄÔºåÊ∏ÖÁêÜ" },
            { word: "over", meaning: "ÁªìÊùüÁöÑ" },
            { word: "floor", meaning: "Âú∞ÊùøÔºåÂú∞Èù¢" },
            { word: "window", meaning: "Á™óÊà∑" },
            { word: "door", meaning: "Èó®" }
        ],
        "Names": [
            { word: "Tom", meaning: "Ê±§ÂßÜ" },
            { word: "Max", meaning: "È©¨ÂÖãÊñØ" }
        ]
    };

    // --- State ---
    let currentUnit = null;
    let currentList = [];
    let currentIndex = 0;
    let score = 0;
    let quizMode = false; // false for English->Chinese, true for Chinese->English? We'll mix it or stick to one.
    
    // --- Initialization ---
    function init() {
        const unitList = document.getElementById('unit-list');
        for (const unit in vocabulary) {
            const btn = document.createElement('button');
            btn.className = 'unit-btn';
            btn.textContent = unit;
            btn.onclick = () => selectUnit(unit);
            unitList.appendChild(btn);
        }
    }
    
    // --- TTS ---
    let preferredVoice = null;

    function loadVoices() {
        const voices = window.speechSynthesis.getVoices();
        // Priority list for English voices (Google US, Microsoft Zira, Samantha, etc.)
        const voicePriorities = [
            'Google US English',
            'Microsoft Zira',
            'Samantha',
            'Alex',
            'Daniel'
        ];

        for (const name of voicePriorities) {
            preferredVoice = voices.find(v => v.name.includes(name));
            if (preferredVoice) break;
        }
    }

    // Initialize voices
    if ('speechSynthesis' in window) {
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
    }

    function speakWord() {
        const word = document.getElementById('fc-word').textContent;
        speak(word);
    }

    function speak(text, lang = 'en-US') {
        if ('speechSynthesis' in window) {
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
        }

        // For English words, try to use online high-quality audio first
        if (lang === 'en-US') {
            // Handle special cases for online audio query if needed
            // For "a/an", just read "a" to avoid confusion or split? 
            // The dictionary usually handles "hello" well. 
            // "I" -> "eye" fix is for TTS, but online audio "I" should be fine.
            
            // Clean text for URL (remove special chars if any, though encodeURIComponent handles it)
            // But we might want to keep the "I" fix if we fallback to TTS
            
            const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
            const audio = new Audio(audioUrl);
            
            audio.play().catch(e => {
                console.log("Online audio failed, falling back to TTS", e);
                speakBrowserTTS(text, lang);
            });
        } else {
            // For Chinese (feedback), use browser TTS
            speakBrowserTTS(text, lang);
        }
    }

    function speakBrowserTTS(text, lang) {
        if ('speechSynthesis' in window) {
            // Fix for "I" being read as "Capital I"
            let textToSpeak = text;
            if (lang === 'en-US' && text === 'I') {
                textToSpeak = 'eye'; 
            }
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = lang; 
            
            // Use preferred voice if available and language matches
            if (lang === 'en-US' && preferredVoice) {
                utterance.voice = preferredVoice;
            }

            utterance.rate = lang === 'zh-CN' ? 1.0 : 0.8; 
            utterance.pitch = 1.1; 
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- Navigation ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        const homeBtn = document.getElementById('home-btn');
        if (viewId === 'root-menu-view') {
            homeBtn.style.display = 'none';
        } else {
            homeBtn.style.display = 'block';
        }
    }

    function goHome() {
        showView('root-menu-view');
        currentUnit = null;
    }

    function showWordMenu() {
        showView('word-menu-view');
    }

    function showMathTableMenu() {
        showView('math-table-view');
        renderMathTable('add'); // Default to addition
    }

    function selectUnit(unit) {
        currentUnit = unit;
        currentList = vocabulary[unit];
        document.getElementById('selected-unit-title').textContent = unit;
        showView('mode-view');
    }

    // --- Flashcard Logic ---
    function startFlashcards() {
        currentIndex = 0;
        showView('flashcard-view');
        updateCard();
    }

    function updateCard() {
        const item = currentList[currentIndex];
        document.getElementById('fc-word').textContent = item.word;
        document.getElementById('fc-meaning').textContent = item.meaning;
        document.getElementById('card').classList.remove('flipped');
        
        // Update Progress
        const percent = ((currentIndex + 1) / currentList.length) * 100;
        document.getElementById('fc-progress').style.width = percent + '%';
    }

    function flipCard() {
        document.getElementById('card').classList.toggle('flipped');
    }

    function nextCard() {
        if (currentIndex < currentList.length - 1) {
            currentIndex++;
            updateCard();
        } else {
            // Maybe loop or finish
            alert("ÊÅ≠ÂñúÔºÅ‰Ω†Â∑≤ÁªèÁúãÂÆå‰∫ÜËøô‰∏™ÂçïÂÖÉÊâÄÊúâÁöÑÂçïËØçÔºÅ");
            currentIndex = 0;
            updateCard();
        }
    }

    function prevCard() {
        if (currentIndex > 0) {
            currentIndex--;
            updateCard();
        }
    }

    // --- Quiz Logic ---
    function startQuiz() {
        // Shuffle list for quiz
        currentList = [...vocabulary[currentUnit]].sort(() => Math.random() - 0.5);
        currentIndex = 0;
        score = 0;
        showView('quiz-view');
        updateQuiz();
    }

    function updateQuiz() {
        if (currentIndex >= currentList.length) {
            finishQuiz();
            return;
        }

        const item = currentList[currentIndex];
        document.getElementById('score').textContent = score;
        document.getElementById('quiz-feedback').textContent = '';
        document.getElementById('quiz-next-btn-container').style.display = 'none';
        
        // Progress
        const percent = (currentIndex / currentList.length) * 100;
        document.getElementById('quiz-progress').style.width = percent + '%';

        // 50% chance: English -> Chinese OR Chinese -> English
        const isEngToChi = Math.random() > 0.5;
        
        let questionText, correctText, wrongSource;
        
        if (isEngToChi) {
            questionText = item.word;
            correctText = item.meaning;
            wrongSource = 'meaning';
            // Add speaker button for English questions
            document.getElementById('quiz-question').innerHTML = `
                ${questionText} 
                <button class="speak-btn" onclick="speak('${questionText.replace(/'/g, "\\'")}')">üîä</button>
            `;
            // Auto-speak English questions
            speak(questionText);
        } else {
            questionText = item.meaning;
            correctText = item.word;
            wrongSource = 'word';
            document.getElementById('quiz-question').textContent = questionText;
        }
        
        // Generate options
        const optionsContainer = document.getElementById('quiz-options');
        optionsContainer.innerHTML = '';
        
        // Get 3 random wrong answers from other words in the SAME unit or ALL units
        // Using all units gives more variety
        let allWords = [];
        for (let u in vocabulary) {
            allWords = allWords.concat(vocabulary[u]);
        }
        
        const wrongOptions = allWords
            .filter(w => w[wrongSource] !== correctText)
            .sort(() => Math.random() - 0.5)
            .slice(0, 3)
            .map(w => w[wrongSource]);
            
        const options = [...wrongOptions, correctText].sort(() => Math.random() - 0.5);
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => checkAnswer(btn, opt === correctText, correctText);
            optionsContainer.appendChild(btn);
        });
    }

    function checkAnswer(btn, isCorrect, correctText) {
        // Disable all buttons
        const opts = document.querySelectorAll('.option-btn');
        opts.forEach(o => o.disabled = true);

        const correctPhrases = ["‰Ω†ÁúüÊ£í!", "Â§™ÂéâÂÆ≥‰∫Ü!", "Á≠îÂØπ‰∫Ü!", "Â•ΩÊ†∑ÁöÑ!", "Excellent!"];
        const wrongPhrases = ["Ê≤°ÂÖ≥Á≥ªÔºåÂÜçËØï‰∏ÄÊ¨°!", "Âä†Ê≤πÂì¶!", "ÂÜçÊÉ≥‰∏ÄÊÉ≥!", "‰∏çË¶ÅÁÅ∞ÂøÉ!", "Try again!"];

        if (isCorrect) {
            btn.classList.add('correct');
            document.getElementById('quiz-feedback').textContent = '‚úÖ Á≠îÂØπ‰∫Ü! Great Job!';
            document.getElementById('quiz-feedback').style.color = 'green';
            score += 10;
            playSound('correct');
            fireworks(); // Trigger fireworks
            
            // Voice feedback
            const msg = correctPhrases[Math.floor(Math.random() * correctPhrases.length)];
            speak(msg, 'zh-CN');
        } else {
            btn.classList.add('wrong');
            btn.classList.add('shake-anim'); // Trigger shake
            // Remove animation class after it finishes so it can be triggered again if needed
            setTimeout(() => btn.classList.remove('shake-anim'), 500);
            
             // Highlight the correct answer
             opts.forEach(o => {
                 if (o.textContent === correctText) {
                     o.classList.add('correct');
                 }
             });

             document.getElementById('quiz-feedback').textContent = `‚ùå ÂìéÂëÄ! Ê≠£Á°ÆÁ≠îÊ°à: ${correctText}`;
             document.getElementById('quiz-feedback').style.color = 'red';
             playSound('wrong');
             
             // Voice feedback
             const msg = wrongPhrases[Math.floor(Math.random() * wrongPhrases.length)];
             speak(msg, 'zh-CN');
        }
        
        document.getElementById('score').textContent = score;
        document.getElementById('quiz-next-btn-container').style.display = 'flex';
    }

    function nextQuestion() {
        currentIndex++;
        updateQuiz();
    }

    function finishQuiz() {
        showView('result-view');
        document.getElementById('final-score').textContent = score;
        
        const maxScore = currentList.length * 10;
        const ratio = score / maxScore;
        let stars = '';
        if (ratio >= 0.9) stars = '‚≠ê‚≠ê‚≠ê (Â§™Ê£í‰∫Ü!)';
        else if (ratio >= 0.6) stars = '‚≠ê‚≠ê (‰∏çÈîôÂì¶!)';
        else stars = '‚≠ê (Âä†Ê≤π!)';
        
        document.getElementById('stars').textContent = stars;
    }
    
    // Simple Audio Context for effects (optional, browser policy might block auto-play but click triggers are fine)
    // For simplicity, we won't use external audio files, maybe just visual feedback is enough.
    function playSound(type) {
        // Placeholder for sound effects
    }

    // --- Effects ---
    const canvas = document.getElementById('fireworks-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animationId = null;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function fireworks() {
        // Launch some particles
        const particleCount = 100;
        const x = window.innerWidth / 2; // Center burst, or could be random
        const y = window.innerHeight / 2;

        for (let i = 0; i < particleCount; i++) {
            particles.push(createParticle(x, y));
        }

        if (!animationId) {
            animateParticles();
        }
    }

    function createParticle(x, y) {
        const angle = Math.random() * Math.PI * 2;
        const velocity = 5 + Math.random() * 5;
        const colors = ['#FF9F1C', '#2EC4B6', '#E71D36', '#FFD700', '#33CC33'];
        return {
            x: x,
            y: y,
            vx: Math.cos(angle) * velocity,
            vy: Math.sin(angle) * velocity,
            color: colors[Math.floor(Math.random() * colors.length)],
            alpha: 1,
            size: Math.random() * 5 + 2
        };
    }

    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach((p, index) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2; // Gravity
            p.alpha -= 0.02; // Fade out

            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();

            if (p.alpha <= 0) {
                particles.splice(index, 1);
            }
        });

        if (particles.length > 0) {
            animationId = requestAnimationFrame(animateParticles);
        } else {
            animationId = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    // --- Math Logic ---
    function renderMathTable(type) {
        const container = document.getElementById('math-table-container');
        container.innerHTML = '';
        const limit = 10;
        
        for (let i = 1; i <= limit; i++) {
            for (let j = 1; j <= limit; j++) {
                let text = '';
                let valid = false;
                
                if (type === 'add') {
                    if (i + j <= 10) {
                        text = `${i} + ${j} = ${i+j}`;
                        valid = true;
                    }
                } else {
                    // Subtraction: ensure result is positive/zero? usually i - j within 10
                    // Let's list subtraction tables for numbers up to 10
                    // e.g. 5 - 1 = 4
                    // i is the minuend (up to 10), j is subtrahend
                    if (i >= j) {
                        text = `${i} - ${j} = ${i-j}`;
                        valid = true;
                    }
                }

                if (valid) {
                    const card = document.createElement('div');
                    card.className = 'math-card';
                    card.textContent = text;
                    // On click: Speak AND Show Modal
                    card.onclick = () => {
                        const speakText = text.replace('+', 'plus').replace('-', 'minus').replace('=', 'equals');
                        speak(speakText);
                        openMathModal(i, j, type === 'add' ? '+' : '-');
                    };
                    container.appendChild(card);
                }
            }
        }
    }
    
    // --- Modal Logic ---
    let currentModalData = null;

    function openMathModal(a, b, symbol) {
        currentModalData = { a, b, symbol };
        const modal = document.getElementById('math-modal');
        const title = document.getElementById('modal-title');
        const visuals = document.getElementById('modal-visuals');
        
        let result;
        if (symbol === '+') result = a + b;
        else result = a - b;
        
        title.textContent = `${a} ${symbol} ${b} = ${result}`;
        visuals.innerHTML = ''; // Clear previous
        
        modal.style.display = 'flex';
        // Force reflow
        void modal.offsetWidth; 
        modal.classList.add('show');
        
        // Play animation
        setTimeout(() => {
             generateVisualsInContainer(visuals, a, b, symbol);
        }, 300);
    }

    function closeMathModal() {
        const modal = document.getElementById('math-modal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
            document.getElementById('modal-visuals').innerHTML = '';
        }, 300);
    }

    function replayMathModal() {
        if (currentModalData) {
             const visuals = document.getElementById('modal-visuals');
             visuals.innerHTML = '';
             generateVisualsInContainer(visuals, currentModalData.a, currentModalData.b, currentModalData.symbol);
        }
    }

    // Updated generateVisuals to support custom container
    function generateVisualsInContainer(container, a, b, symbol) {
        const icon = ['üçé', 'üçå', 'üê±', 'üê∂', 'üåü', 'üéà'][Math.floor(Math.random() * 6)];
        
        if (symbol === '+') {
            // Addition: Show first group
            for(let i=0; i<a; i++) {
                const span = document.createElement('span');
                span.className = 'calc-icon';
                span.textContent = icon;
                container.appendChild(span);
            }
            
            // Add a visual separator (optional, or just spacing)
            // Wait 1s, then add second group one by one
            let delay = 1000;
            
            for(let i=0; i<b; i++) {
                setTimeout(() => {
                    const span = document.createElement('span');
                    span.className = 'calc-icon added';
                    span.textContent = icon;
                    container.appendChild(span);
                }, delay);
                delay += 800; // 800ms gap between each added item
            }
        } else {
            // Subtraction: Show ALL items first
            for(let i=0; i<a; i++) {
                const span = document.createElement('span');
                span.className = 'calc-icon';
                span.textContent = icon;
                // Use a unique enough ID for this container context
                // Using random to avoid conflicts if multiple calls
                const uniqueId = `sub-icon-${Math.random().toString(36).substr(2, 9)}-${i}`;
                span.id = uniqueId; 
                span.dataset.idx = i;
                container.appendChild(span);
            }
            
            // Wait 1s, then fade out last b items one by one
            let delay = 1000;
            const items = Array.from(container.children); // Snapshot of items
            
            for(let i=0; i<b; i++) {
                setTimeout(() => {
                    // Remove from the end (right side)
                    const idx = a - 1 - i;
                    if (items[idx]) items[idx].classList.add('faded');
                }, delay);
                delay += 800; // 800ms gap between each removal
            }
        }
    }

    // Wrapper for Game View usage (backwards compatibility)
    function generateVisuals(a, b, symbol) {
        const container = document.getElementById('math-visuals');
        generateVisualsInContainer(container, a, b, symbol);
    }

    let mathScore = 0;
    let mathQuestion = null;

    function startMathGame() {
        mathScore = 0;
        document.getElementById('math-score').textContent = mathScore;
        showView('math-game-view');
        updateMathQuestion();
    }

    function updateMathQuestion() {
        document.getElementById('math-feedback').textContent = '';
        document.getElementById('math-next-btn-container').style.display = 'none';
        document.getElementById('math-visuals').innerHTML = '';

        // Generate Question
        const isAdd = Math.random() > 0.5;
        let a, b, result, symbol;
        
        if (isAdd) {
            // result <= 10
            result = Math.floor(Math.random() * 10) + 1; // 1 to 10
            a = Math.floor(Math.random() * result); // 0 to result
            b = result - a;
            symbol = '+';
        } else {
            // a <= 10
            a = Math.floor(Math.random() * 10) + 1;
            b = Math.floor(Math.random() * (a + 1)); // 0 to a
            result = a - b;
            symbol = '-';
        }

        mathQuestion = { a, b, result, symbol };
        document.getElementById('math-question').textContent = `${a} ${symbol} ${b} = ?`;
        
        // Visuals - Show button first
        document.getElementById('math-visuals').innerHTML = '<button class="btn btn-secondary" style="font-size: 1em; padding: 10px 20px;" onclick="showMathHint()">üëÄ Êü•ÁúãÊèêÁ§∫ (Show Hint)</button>';
        
        // Options
        const optionsContainer = document.getElementById('math-options');
        optionsContainer.innerHTML = '';
        
        let wrongOpts = [];
        while(wrongOpts.length < 3) {
            let r = Math.floor(Math.random() * 11); // 0-10
            if (r !== result && !wrongOpts.includes(r)) wrongOpts.push(r);
        }
        
        const options = [...wrongOpts, result].sort(() => Math.random() - 0.5);
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => checkMathAnswer(btn, opt === result);
            optionsContainer.appendChild(btn);
        });

        // Speak question
        const qText = `${a} ${symbol === '+' ? 'plus' : 'minus'} ${b}`;
        speak(qText);
    }

    function showMathHint() {
        document.getElementById('math-visuals').innerHTML = '';
        generateVisuals(mathQuestion.a, mathQuestion.b, mathQuestion.symbol);
    }
    
    // Legacy function removed/replaced by generateVisualsInContainer logic above
    // function generateVisuals(a, b, symbol) { ... } -> now just a wrapper


    function checkMathAnswer(btn, isCorrect) {
        const opts = document.querySelectorAll('#math-options .option-btn');
        opts.forEach(o => o.disabled = true);

        const correctPhrases = ["‰Ω†ÁúüÊ£í!", "ÁÆóÂØπ‰∫Ü!", "Â§©Êâç!", "Correct!"];
        const wrongPhrases = ["ÂÜçÁÆóÁÆóÂì¶!", "Âä†Ê≤π!", "Try again!"];

        if (isCorrect) {
            btn.classList.add('correct');
            document.getElementById('math-feedback').textContent = '‚úÖ Á≠îÂØπ‰∫Ü!';
            document.getElementById('math-feedback').style.color = 'green';
            mathScore += 10;
            playSound('correct');
            fireworks();
            
            const msg = correctPhrases[Math.floor(Math.random() * correctPhrases.length)];
            speak(msg, 'zh-CN');
        } else {
            btn.classList.add('wrong');
            btn.classList.add('shake-anim');
            setTimeout(() => btn.classList.remove('shake-anim'), 500);
            
            // Highlight correct
            opts.forEach(o => {
                if (parseInt(o.textContent) === mathQuestion.result) {
                    o.classList.add('correct');
                }
            });

            document.getElementById('math-feedback').textContent = `‚ùå Ê≠£Á°ÆÁ≠îÊ°à: ${mathQuestion.result}`;
            document.getElementById('math-feedback').style.color = 'red';
            playSound('wrong');
            
            const msg = wrongPhrases[Math.floor(Math.random() * wrongPhrases.length)];
            speak(msg, 'zh-CN');
        }
        
        document.getElementById('math-score').textContent = mathScore;
        document.getElementById('math-next-btn-container').style.display = 'flex';
    }

    function nextMathQuestion() {
        updateMathQuestion();
    }

    // --- Logic Game (200 Questions) ---
    let logicQuestions = [];
    let logicIndex = 0;
    let logicScore = 0;

    function startLogicGame() {
        generateLogicQuestions();
        logicIndex = 0;
        logicScore = 0;
        document.getElementById('logic-score').textContent = logicScore;
        showView('logic-game-view');
        updateLogicQuestion();
    }

    function generateLogicQuestions() {
        logicQuestions = [];
        // Generate 200 questions procedurally
        for (let i = 0; i < 200; i++) {
            const type = Math.floor(Math.random() * 18); // Now 8 types!
            let q = {};
            
            // 1. Number Sequence: 1, 3, 5, ?
            if (type === 0) {
                const start = Math.floor(Math.random() * 3) + 1; 
                const step = Math.floor(Math.random() * 2) + 1; 
                const seq = [start, start+step, start+2*step];
                q.text = `ÊâæËßÑÂæã (Pattern): ${seq.join(', ')}, ?`;
                q.answer = start + 3*step;
                q.options = generateOptions(q.answer);
            }
            // 2. Shape Pattern: üçé, üçå, üçé, ?
            else if (type === 1) {
                const icons = ['üçé', 'üçå', 'üê±', 'üê∂', 'üåü', 'üéà', 'üîµ', 'üî∫'];
                const a = icons[Math.floor(Math.random() * icons.length)];
                let b = icons[Math.floor(Math.random() * icons.length)];
                while(a === b) b = icons[Math.floor(Math.random() * icons.length)];
                
                const patternType = Math.random() > 0.5 ? 'ABAB' : 'AABB';
                if (patternType === 'ABAB') {
                    q.text = `ÊâæËßÑÂæã (Pattern): ${a}, ${b}, ${a}, ?`;
                    q.answer = b;
                    q.options = [a, b, icons[Math.floor(Math.random()*icons.length)], icons[Math.floor(Math.random()*icons.length)]];
                } else {
                    q.text = `ÊâæËßÑÂæã (Pattern): ${a}, ${a}, ${b}, ?`;
                    q.answer = b; 
                    q.options = [a, b, icons[Math.floor(Math.random()*icons.length)], icons[Math.floor(Math.random()*icons.length)]];
                }
                q.options = [...new Set(q.options)].slice(0, 4);
                while(q.options.length < 4) {
                   const r = icons[Math.floor(Math.random()*icons.length)];
                   if(!q.options.includes(r)) q.options.push(r);
                }
                q.options = q.options.sort(() => Math.random() - 0.5);
            }
            // 3. Simple Equation Logic: üçé + 1 = 3, üçé = ?
            else if (type === 2) {
                const icons = ['üçé', 'üçå', 'üê±', 'üê∂', 'üåü'];
                const icon = icons[Math.floor(Math.random() * icons.length)];
                const val = Math.floor(Math.random() * 5) + 1; 
                const res = val + Math.floor(Math.random() * 3) + 1; 
                const diff = res - val;
                
                q.text = `Â∑≤Áü• (If): ${icon} + ${diff} = ${res}, ÈÇ£‰πà (Then) ${icon} = ?`;
                q.answer = val;
                q.options = generateOptions(val);
            }
            // 4. Comparison: Which is biggest?
            else if (type === 3) {
                const n1 = Math.floor(Math.random() * 10);
                const n2 = Math.floor(Math.random() * 10);
                const n3 = Math.floor(Math.random() * 10);
                if (n1 !== n2 && n2 !== n3 && n1 !== n3) {
                    const max = Math.max(n1, n2, n3);
                    q.text = `Âì™‰∏™Êï∞Â≠óÊúÄÂ§ß? (Which is biggest?): ${n1}, ${n2}, ${n3}`;
                    q.answer = max;
                    q.options = [n1, n2, n3].sort(() => Math.random() - 0.5);
                    q.options.push(Math.floor(Math.random()*10));
                    q.options = [...new Set(q.options)].sort(() => Math.random() - 0.5);
                } else {
                    q.text = `${n1} > ? (ÈÄâ‰∏Ä‰∏™ÊØîÂÆÉÂ∞èÁöÑÊï∞)`;
                    q.answer = n1 - 1; 
                    if(q.answer < 0) q.answer = 0; 
                    q.options = [q.answer, n1+1, n1+2, n1+3].sort(() => Math.random() - 0.5);
                }
            }
            // 5. Word Problem (Queuing)
            else if (type === 4) {
                const total = Math.floor(Math.random() * 5) + 5; 
                const pos = Math.floor(Math.random() * (total - 2)) + 1; 
                q.text = `Èòü‰ºçÈáåÊúâ ${total} ‰∏™‰∫∫„ÄÇÊàëÊòØÁ¨¨ ${pos} ‰∏™„ÄÇÊàëÂêéÈù¢ÊúâÂá†‰∏™‰∫∫?`;
                q.answer = total - pos;
                q.options = generateOptions(q.answer);
            }
            // 6. Clock/Time Logic (Simple hours)
            else if (type === 5) {
                const hour = Math.floor(Math.random() * 12) + 1;
                const after = Math.floor(Math.random() * 3) + 1;
                let newHour = hour + after;
                if (newHour > 12) newHour -= 12;
                
                q.text = `Áé∞Âú®ÊòØ ${hour} ÁÇπ (Now ${hour}:00)„ÄÇËøá ${after} Â∞èÊó∂ÊòØÂá†ÁÇπ?`;
                q.answer = newHour;
                q.options = generateOptions(newHour);
            }
            // 7. Geometry Counting (Sides)
            else if (type === 6) {
                const shapes = [
                    { name: '‰∏âËßíÂΩ¢ (Triangle)', sides: 3 },
                    { name: 'Ê≠£ÊñπÂΩ¢ (Square)', sides: 4 },
                    { name: '‰∫îËæπÂΩ¢ (Pentagon)', sides: 5 }
                ];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                q.text = `${shape.name} ÊúâÂá†Êù°Ëæπ? (How many sides?)`;
                q.answer = shape.sides;
                q.options = [3, 4, 5, 6].sort(() => Math.random() - 0.5);
            }
            // 8. Simple Money/Counting (Apples cost)
            else if (type === 7) {
                const price = Math.floor(Math.random() * 3) + 1; // 1-3
                const count = Math.floor(Math.random() * 3) + 2; // 2-4
                const total = price * count;
                q.text = `‰∏Ä‰∏™ üçé ${price} ÂÖÉ„ÄÇ‰π∞ ${count} ‰∏™ üçé Ë¶ÅÂ§öÂ∞ëÈí±?`;
                q.answer = total;
                q.options = generateOptions(total);
            }
            // 9. Age Logic
            else if (type === 8) {
                const age = Math.floor(Math.random() * 5) + 5; // 5-9
                const diff = Math.floor(Math.random() * 3) + 1;
                q.text = `Â∞èÊòé ${age} Â≤Å„ÄÇÂ¶πÂ¶πÊØî‰ªñÂ∞è ${diff} Â≤Å„ÄÇÂ¶πÂ¶πÂá†Â≤Å?`;
                q.answer = age - diff;
                q.options = generateOptions(q.answer);
            }
            // 10. Missing Operator
            else if (type === 9) {
                const a = Math.floor(Math.random() * 5) + 2;
                const b = Math.floor(Math.random() * 4) + 1;
                const ops = ['+', '-'];
                const op = ops[Math.floor(Math.random() * ops.length)];
                let res;
                if (op === '+') res = a + b;
                else res = a - b;
                q.text = `${a} ? ${b} = ${res}`;
                q.answer = op;
                q.options = ['+', '-', 'x', '='];
            }
            // 11. Between Numbers
            else if (type === 10) {
                const start = Math.floor(Math.random() * 10);
                const end = start + 2;
                q.text = `Âì™‰∏™Êï∞Âú® ${start} Âíå ${end} ‰πãÈó¥?`;
                q.answer = start + 1;
                q.options = generateOptions(q.answer);
            }
            // 12. Odd/Even
            else if (type === 11) {
                const isOdd = Math.random() > 0.5;
                const targetType = isOdd ? 'ÂçïÊï∞ (Odd)' : 'ÂèåÊï∞ (Even)';
                const start = Math.floor(Math.random() * 5) * 2; // Even base
                let nums = [];
                let correct;
                if (isOdd) {
                    correct = start + 1;
                    nums = [start, start + 2, start + 4, correct];
                } else {
                    correct = start + 2;
                    nums = [start + 1, start + 3, start + 5, correct];
                }
                q.text = `ÊâæÂá∫${targetType}: ${nums.sort(() => Math.random() - 0.5).join(', ')}`;
                q.answer = correct;
                q.options = nums.sort(() => Math.random() - 0.5);
            }
            // 13. Double/Half
            else if (type === 12) {
                const isDouble = Math.random() > 0.5;
                const num = Math.floor(Math.random() * 5) + 1;
                if (isDouble) {
                    q.text = `${num} ÁöÑÂä†ÂÄç (Double) ÊòØÂ§öÂ∞ë?`;
                    q.answer = num * 2;
                } else {
                    const evenNum = num * 2;
                    q.text = `${evenNum} ÁöÑ‰∏ÄÂçä (Half) ÊòØÂ§öÂ∞ë?`;
                    q.answer = num;
                }
                q.options = generateOptions(q.answer);
            }
            // 14. Day Sequence
            else if (type === 13) {
                const days = ['ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠', 'ÊòüÊúüÊó•'];
                const start = Math.floor(Math.random() * 4);
                q.text = `${days[start]}, ${days[start+1]}, ?`;
                q.answer = days[start+2];
                q.options = [days[start+2], days[(start+3)%7], days[(start+4)%7], days[(start+5)%7]].sort(() => Math.random() - 0.5);
            }
            // 15. Simple Direction
            else if (type === 14) {
                const start = 0;
                const right = Math.floor(Math.random() * 5) + 3;
                const left = Math.floor(Math.random() * 2) + 1;
                q.text = `‰ªé 0 ÂºÄÂßãÔºåÂêëÂè≥Ëµ∞ ${right} Ê≠•ÔºåÂÜçÂêëÂ∑¶Ëµ∞ ${left} Ê≠•„ÄÇÂú®Âì™?`;
                q.answer = right - left;
                q.options = generateOptions(q.answer);
            }
            // 16. Triple Addition
            else if (type === 15) {
                const a = Math.floor(Math.random() * 5);
                const b = Math.floor(Math.random() * 5);
                const c = Math.floor(Math.random() * 5);
                q.text = `${a} + ${b} + ${c} = ?`;
                q.answer = a + b + c;
                q.options = generateOptions(q.answer);
            }
            // 17. Simple Subtraction Word Problem
            else if (type === 16) {
                const total = Math.floor(Math.random() * 5) + 5;
                const eaten = Math.floor(Math.random() * 3) + 1;
                q.text = `Êúâ ${total} ‰∏™ üçéÔºåÂêÉ‰∫Ü ${eaten} ‰∏™„ÄÇËøòÂâ©Âá†‰∏™?`;
                q.answer = total - eaten;
                q.options = generateOptions(q.answer);
            }
            // 18. Shape Math
            else if (type === 17) {
                 const shapes = [
                    { name: 'üî∫', val: 3 },
                    { name: 'üü¶', val: 4 },
                    { name: '‚¨†', val: 5 }
                ];
                const s1 = shapes[Math.floor(Math.random() * shapes.length)];
                const s2 = shapes[Math.floor(Math.random() * shapes.length)];
                q.text = `${s1.name} + ${s2.name} = ? Êù°Ëæπ`;
                q.answer = s1.val + s2.val;
                q.options = generateOptions(q.answer);
            }
            
            logicQuestions.push(q);
        }
    }

    function generateOptions(answer) {
        let opts = [answer];
        while(opts.length < 4) {
            let r = answer + Math.floor(Math.random() * 5) - 2;
            if (r < 0) r = 0;
            if (!opts.includes(r)) opts.push(r);
        }
        return opts.sort(() => Math.random() - 0.5);
    }

    function updateLogicQuestion() {
        if (logicIndex >= logicQuestions.length) {
            // End of Logic Game
             alert("ÂìáÔºÅ‰Ω†Â§™ÂéâÂÆ≥‰∫ÜÔºÅÂÆåÊàê‰∫ÜÊâÄÊúâÈÄªËæëÊåëÊàòÔºÅ");
             goHome();
             return;
        }

        const q = logicQuestions[logicIndex];
        document.getElementById('logic-question').textContent = `${logicIndex + 1}. ${q.text}`;
        document.getElementById('logic-feedback').textContent = '';
        document.getElementById('logic-next-btn-container').style.display = 'none';
        
        // Progress
        const percent = ((logicIndex) / 200) * 100;
        document.getElementById('logic-progress').style.width = percent + '%';

        const container = document.getElementById('logic-options');
        container.innerHTML = '';
        
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => checkLogicAnswer(btn, opt === q.answer, q.answer);
            container.appendChild(btn);
        });
        
        // Speak logic question (Chinese mainly)
        // If it contains icons, we might skip reading or read simplified
        // Simple heuristic: read text content
        speak(q.text.replace(/üçé|üçå|üê±|üê∂|üåü|üéà|üîµ|üî∫/g, "ÂõæÂΩ¢"), 'zh-CN');
    }

    function checkLogicAnswer(btn, isCorrect, correctVal) {
        const opts = document.querySelectorAll('#logic-options .option-btn');
        opts.forEach(o => o.disabled = true);

        if (isCorrect) {
            btn.classList.add('correct');
            document.getElementById('logic-feedback').textContent = '‚úÖ Á≠îÂØπ‰∫Ü! ÁúüËÅ™Êòé!';
            document.getElementById('logic-feedback').style.color = 'green';
            logicScore += 10;
            playSound('correct');
            fireworks();
            speak("Á≠îÂØπ‰∫Ü!", 'zh-CN');
        } else {
            btn.classList.add('wrong');
            btn.classList.add('shake-anim');
            setTimeout(() => btn.classList.remove('shake-anim'), 500);
            
            // Highlight correct
            opts.forEach(o => {
                // Check equality. For icons, string compare. For numbers, value compare.
                if (o.textContent == correctVal) {
                    o.classList.add('correct');
                }
            });

            document.getElementById('logic-feedback').textContent = `‚ùå Ê≠£Á°ÆÁ≠îÊ°à: ${correctVal}`;
            document.getElementById('logic-feedback').style.color = 'red';
            playSound('wrong');
            speak("Ê≤°ÂÖ≥Á≥ªÔºå‰∏ãÊ¨°Âä†Ê≤π!", 'zh-CN');
        }
        
        document.getElementById('logic-score').textContent = logicScore;
        document.getElementById('logic-next-btn-container').style.display = 'flex';
    }

    function nextLogicQuestion() {
        logicIndex++;
        updateLogicQuestion();
    }

    // Start
    init();

</script>

</body>
</html>
